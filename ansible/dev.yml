- name: setup local development environment
  hosts: all

  vars:
    - spark_version: 1.3.1
    - postgresql_version: 9.4

  tasks:
    - name: install packages
      sudo: yes
      apt: name={{item}} state=installed update_cache=yes
      with_items:
        - libsnappy-dev
        - liblzma-dev
        - openjdk-7-jdk
        - python-numpy
        - python-pandas
        - wget
        - ca-certificates

    - name: get the current release codename for adding apt repositories
      shell: "lsb_release -cs"
      register: codename

    - name: add apt repository for postgresql
      sudo: yes
      apt_repository: repo="deb http://apt.postgresql.org/pub/repos/apt/ {{ codename.stdout }}-pgdg main" state=present

    - name: trust the postgresql apt repository signing key
      sudo: yes
      apt_key: id=ACCC4CF8 url=https://www.postgresql.org/media/keys/ACCC4CF8.asc state=present

    - name: install postgresql packages
      sudo: yes
      apt: name={{item}} state=installed update_cache=yes
      with_items:
        - libpq-dev
        - postgresql-{{postgresql_version}}
        - postgresql-contrib-{{postgresql_version}}
        - postgresql-server-dev-{{postgresql_version}}

    - name: install anaconda
      command: "{{item}} chdir={{ansible_env.HOME}} creates=miniconda"
      with_items:
        - wget http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh
        - chmod +x miniconda.sh
        - ./miniconda.sh -b -f

    - name: delete miniconda installer
      command: rm miniconda.sh chdir={{ansible_env.HOME}}

    - name: source anaconda
      lineinfile: dest={{ansible_env.HOME}}/.bashrc regexp="^export.*miniconda2/bin" line="export PATH={{ansible_env.HOME}}/miniconda2/bin:$PATH"

    - name: install common python packages
      command: "{{item}} chdir={{ansible_env.HOME}}"
      with_items:
        - miniconda2/bin/conda update --yes conda
        - miniconda2/bin/conda install --yes atlas numpy scipy matplotlib nose dateutil pandas flask supervisor tornado

    - name: get spark
      get_url: url=http://d3kbcqa49mib13.cloudfront.net/spark-{{spark_version}}-bin-hadoop2.4.tgz dest={{ansible_env.HOME}}/spark.tgz

    - name: install spark
      unarchive: src={{ansible_env.HOME}}/spark.tgz dest={{ansible_env.HOME}}

    - name: delete spark installer
      file: path={{ansible_env.HOME}}/spark-{{spark_version}}-bin-hadoop2.4.tgz state=absent

    - name: source spark
      lineinfile: >
        dest={{ansible_env.HOME}}/.bashrc
        regexp="^export SPARK_HOME"
        line="export SPARK_HOME={{ansible_env.HOME}}/spark-{{spark_version}}-bin-hadoop2.4"
    - name: source pyspark
      lineinfile: >
        dest={{ansible_env.HOME}}/.bashrc
        regexp="^export PYTHONPATH"
        line="export PYTHONPATH=$SPARK_HOME/python:$SPARK_HOME/python/lib/py4j-0.8.2.1-src.zip"

    - name: setup project dependencies
      command: "{{ansible_env.HOME}}/miniconda2/bin/pip install telemetry-tools python_moztelemetry psycopg2 awscli"
